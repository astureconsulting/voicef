<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voice AI Chat Agent</title>
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #1CB5E0 0%, #000851 100%);
      font-family: 'Poppins', sans-serif;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    #container {
      max-width: 430px;
      margin: 60px auto;
      background: rgba(10, 15, 45, 0.97);
      border-radius: 24px;
      box-shadow: 0 8px 24px #0004;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
    }
    h2 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 16px;
    }
    #chat {
      min-height: 320px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 12px;
      background: rgba(40, 50, 90, 0.85);
      border-radius: 12px;
      padding: 14px;
      font-size: 1rem;
    }
    .msg.user {
      color: #3af2f3;
      text-align: right;
      margin-bottom: 8px;
    }
    .msg.bot {
      color: #ffe177;
      text-align: left;
      margin-bottom: 8px;
    }
    #start-stop {
      background: linear-gradient(90deg, #ffc371, #1CB5E0);
      color: #222;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    #start-stop.listening {
      animation: pulseGlow 1.2s infinite alternate;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 16px 6px #23cbe099; }
      100% { box-shadow: 0 0 32px 10px #ffe17799; }
    }
    #status {
      text-align: center;
      font-size: 0.95em;
      color: #00e8ff;
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>üéß Voice AI Assistant</h2>
    <div id="chat"></div>
    <div id="status"></div>
    <button id="start-stop">‚ñ∂Ô∏è Start Conversation</button>
  </div>

<script>
  const startBtn = document.getElementById("start-listening");
  const chatDiv = document.getElementById("chat");
  const statusDiv = document.getElementById("status");

  let recognition;
  let isListening = false;
  let isResponding = false;

  function appendMsg(sender, text) {
    const msg = document.createElement("div");
    msg.className = "msg " + sender;
    msg.textContent = text;
    chatDiv.appendChild(msg);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  function playAudio(url, callback) {
    if (!url) return callback?.();
    const audio = new Audio(url);
    isResponding = true;

    // Stop listening while audio is playing
    recognition.stop();

    audio.play()
      .then(() => console.log("‚úÖ Audio playing:", url))
      .catch(err => console.error("‚ùå Audio error:", err));

    audio.onended = () => {
      console.log("üîÅ Audio ended");
      isResponding = false;
      setTimeout(() => {
        if (isListening) {
          console.log("üé§ Restarting listening after response...");
          recognition.start();
        }
      }, 300);
      callback?.();
    };
  }

  if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.continuous = true; // ‚úÖ Keep listening continuously

    recognition.onstart = () => {
      console.log("üé§ Listening...");
      statusDiv.textContent = "üé§ Listening...";
    };

    recognition.onend = () => {
      if (!isListening) {
        console.log("üõë User stopped assistant.");
        startBtn.classList.remove("listening");
        startBtn.textContent = "üé§ Start Conversation";
        statusDiv.textContent = "";
      } else if (!isResponding) {
        console.log("‚è≥ Mic stopped unexpectedly, restarting...");
        recognition.start(); // fallback
      }
    };

    recognition.onerror = event => {
      console.error("üö´ Speech error:", event.error);
      statusDiv.textContent = "‚ùå Mic error: " + event.error;
      if (isListening && !isResponding) {
        setTimeout(() => recognition.start(), 500);
      }
    };

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript.trim();
      if (!transcript) return;

      appendMsg("user", transcript);
      statusDiv.textContent = "ü§ñ Thinking...";

      recognition.stop(); // üõë Pause recognition while processing

      fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: transcript })
      })
        .then(res => res.json())
        .then(data => {
          appendMsg("bot", data.response);
          statusDiv.textContent = "üîä Speaking...";
          playAudio(data.audio_url);
        })
        .catch(err => {
          console.error("‚ùå Server error:", err);
          statusDiv.textContent = "‚ùå Response failed.";
          if (isListening) recognition.start(); // retry listening
        });
    };

    startBtn.onclick = () => {
      if (!isListening) {
        isListening = true;
        startBtn.textContent = "üõë Stop Conversation";
        startBtn.classList.add("listening");
        recognition.start();
      } else {
        isListening = false;
        isResponding = false;
        recognition.stop();
        startBtn.textContent = "üé§ Start Conversation";
        startBtn.classList.remove("listening");
        statusDiv.textContent = "üõë Assistant stopped.";
      }
    };
  } else {
    startBtn.disabled = true;
    statusDiv.textContent = "‚ùå Speech recognition not supported.";
  }
</script>

</body>
</html>
